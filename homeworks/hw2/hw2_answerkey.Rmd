```{r message = FALSE}
# Notes for formatting:
# include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks.
# echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures.
# message = FALSE prevents messages that are generated by code from appearing in the finished file.
# warning = FALSEprevents warnings that are generated by code from appearing in the finished.
library(data.table)
library(readr)
library(readxl)
library(tidyverse)
```

---
title: "Empirical Exercise 2 Answer Key"
author: Eugene Tan
output: html_notebook
---

This problem set is due on October 26. I strongly recommend to start working on the homework early. You can work in pairs and submit a common solution. Please submit the homework as an R markdown file (if there are data files, they put all the files in a zip file). The code must run without errors. To make this easier, set the working directory at the beginning so it can be easily changed by someone else running the code.

For this exercise you will use a dataset collected by S&P Global. Choose one of the datasets available, which have data for either 2009 or 2018 for one of the following ISOs: MISO, PJM, ERCOT, or New England ISO. The goal of the exercise is to build the supply curve for a wholesale electricity market and to analyze how costs determine the composition of fuels and emissions. We will also use the exercise to see how things would change with a carbon tax.

#### Select the following variables from your dataset: 
* Plant Unit key
* Primary fuel type
* Generation technology
* Summer capacity MW
* Variable O&M cost per MWh (this is the variable cost)
* Total fuel cost per MWh (this is part of the variable cost) 
* Emission allowances costs (this is part of the variable cost) 
* Fixed O&M cost
* Heat rate btu/ kwh
* Heat input (MMBTU)
* Net generation MWh
* Capacity factor
* NOX Emissions Rate (lbs/MMBtu)
* SO2 Emissions Rate (lbs/MMBtu)
* CO2 Emissions Rate (lbs/MMBtu)

```{r echo = TRUE, warning = FALSE}
ercot2018 <- fread("data/ercot2018.csv")
ercot2009 <- fread("data/ERCOT_2009.csv")
ne2009 <- read_excel("data/ISO_NE_2009.xls", 
         col_types = c("text", "numeric", "numeric", 
         "text", "text", "text", "text", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "text", "text", "text", 
         "text", "text", "text", "text", "text", 
         "text", "text"))
ne2009 <- as.data.table(ne2009)
miso2018 <- fread("data/MISO2018.csv")
ne2018 <- fread("data/NEISO_2018.csv")
ny2018 <- fread("data/NYISO_2018.csv") 
pjm2009 <- fread("data/PJM2009.csv", skip = 31)

# Get all the data in one list and name it
alldata <- list(ercot2018, ercot2009,ne2009,miso2018,ne2018,ny2018, pjm2009)
names(alldata) <- c("ercot2018", "ercot2009","ne2009","miso2018","ne2018","ny2018", "pjm2009")

# Get a unique list of all the column names
oldcols <- unique(unlist(sapply(alldata, names)))

# Map each of these to the variable name I want
newcols <- c('name','pkey','pukey','unitno','fueltype','tech','operating','capacity','capacity_adj','capacity_cum','vcost_om', 'vcost_fuel','vcost_om2','vcost_om3','vcost_emissions','fcost','tcost_om','heat_rate','heat_input','net_generation','cap_factor','nox','sox','co2','cogen','gscfuelsrc','gscnonfuelsrc','gscallowsrc','gscheatratesrc', 'gscheatinputsrc','gscgensrc','nox_emratesrc','so2_emratesrc','co2_emratesrc','name')

# Print to see that these match up.
names(newcols) <- oldcols

# Now loop through all the dts and set the new names and only choose the columns we want. 
format <- function (dt){
  # Set the new names for each column
  setnames(dt,oldcols, newcols, skip_absent = T)
  return(dt)
}

# Apply the above fucntion
alldata <- lapply(alldata, format)
```

### Part 1
Start by cleaning and understanding your data. For this, do the following:
#### What does each variable represent?
Just check understanding here: 

* Plant Unit key is the plant unit key.  In each plant, there may be multiple generators with different marginal costs. So each generator or unit has its own unique row in the dataset
* Primary fuel type - form of primary energy, one of "Solar", "Other Fuel", "Water", "Coal","Uranium","Natural Gas","Biomass","Petroleum Products","".
* Generation Technology - form of generator, e.g. Combustion Turbine, Combined Cycle, Hydro, Nuclear, Pumped Storage, Internal Combustion, Steam Turbine, Other, Solar, Wind.
* Summer capacity MW - capacity measured during summer
* Variable O&M cost per MWh - 

#### Assign convenient yet meaningful names to each variable in the dataset.
```{r}
# Get the list of columns we want to select
wantcols <- c("pukey",'fueltype',"tech","capacity","vcost_om","vcost_fuel","vcost_emissions","fcost","heat_rate","heat_input","net_generation","cap_factor","nox","sox","co2")

selec <- function (dt){
  # Select only the columns we want
  dt <- dt[,..wantcols]
  return(dt)
}

alldata <- lapply(alldata, selec)

# Print the top couple rows of each to see that it worked. 
lapply(alldata, dim) # Check there are 15 columns
```

#### What is the class of each variable? Make sure to convert them to the proper class before doing this. For example, if net generation is a character, make it numeric.
```{r}
# ANSWER KEY ONLY: I'll join all the data to be one data type in order not use loops 
# all the time for readability, and filter at the end to make it work for each graph. 
dt <- rbindlist(alldata, use.names = TRUE, idcol = 'isoyear')
# Capture the iso (as many characters as you like from a-z at the beginning)
dt[,iso:=str_match(isoyear,"^[a-z]*")] 
# Capture the year (4 digits from 0-9)
dt[,year:=as.integer(str_match(isoyear,"[0-9]{4}$"))] 


# Select the ones that I want to change the type of using a regular expression
convert_cols <- names(dt)[grepl('cost|heat|gen|cap',names(dt))]

# Some data cleaning needed before changing to numeric. 
# gsub isn't vectorized, so can't do this in data.table. 
for (col in convert_cols){
  # This is needed for all except ne2009
  # There are some commas that separate numbers that result in nas e.g. 100,000
  dt[[col]] <- gsub(",","",dt[[col]]) 
  # For pjm 2009 only because 0s are entered as "(0.00)"
  dt[[col]] <- gsub("\\(","",dt[[col]])
  dt[[col]] <- gsub("\\)","",dt[[col]])
}

# error checking why 
#error <- dt[,as.numeric(vcost_emissions)]
#dt[is.na(error)]


# Convert the columns to the right datatype. 
dt[, (convert_cols) := lapply(.SD, as.numeric),.SDcols = convert_cols]
# Check it worked
str(dt)
```

#### Describe each variable: what values does it take? Do you have any concerns about some variable (extreme values, missing values)?
```{r}
str(dt)
summary(dt)

# Extreme values:

# Heat rate - the generator shouldn't be able to produce more secondary than primary energy. 
dt[,energy_efficiency := 3412.14/heat_rate] # convert btu/kwh to kwh/kwh
# Problematic generators by dataset
dt[energy_efficiency>1, .N, by =isoyear] 

# Capacity factor should be <100
dt[cap_factor>100]
dt[cap_factor>100, .N, by =isoyear] 
# Total problematic rows
dt[energy_efficiency>1|cap_factor>100] 
dt[energy_efficiency>1|cap_factor>100, .N, by =isoyear] 

# Missing values - can't say anything here really.
# Anything with fuel type missing is just an empty row that was imported by accident.
dt<-dt[!fueltype == ""]
summary(dt)
dt[is.na(net_generation), .N, by = isoyear]
dt[is.na(net_generation), .N, by = fueltype]
dt[is.na(net_generation), .N, by = tech]
```

### Part 2
Now let’s look at the importance of each fuel in this market.
#### a
What is the fuel composition of this market according to capacity (i.e. how
much capacity for each fuel)? Show it in a pie chart.
```{r}

for (name in names(alldata)){
  print(
    ggplot(dt[isoyear == name,.(capacity = sum(capacity, na.rm=T)), by = fueltype], aes(x = "",y = capacity, fill = fueltype)) + 
    geom_bar(stat="identity", width=1) +
    coord_polar("y", start=0)+
    ggtitle(name) + 
    theme_void()+
    geom_text(aes(y = ypos, label = fueltype), color = "white", size=6) +
  scale_fill_brewer(palette="Set1")
  )
}

```



(b) What is the fuel composition of this market in terms of net generation?
Show it in a pie chart.
(c) Why are they different or similar?
(d) How much does each fuel contribute to NOx, SO2, and CO2 emissions? Choose an appropriate plot type to answer this.
3. Organize the data and plot the generation supply curve using a different color for each fuel (Check here for a reference about supply curves.). The idea is to have a plot in which each plant is a dot, its height is its variable cost and its x- coordinate is the capacity of the system at a cost equal or lower than the plant’s. For this, you have to order generators according to variable cost, and calculate the cumulative capacity of the system. Use geom point such that each plant is a dot, but do not connect the dots. Label the plot properly, add a title and a legend.
4. In the supply curve, are fuels ordered by cost? What do you think is the role of cost in explaining the differences between the capacity and net generation shares of each fuel?
5. Now you will create three values that we will use to represent load. Let’s assume average load is 60% of capacity, winter peak is 80% of capacity, and summer peak is 90% of capacity.
(a) Compute these three values of load.
(b) Add the load values to the supply curve plot as vertical lines. Save this plot
as a pdf file using ggsave.
 For each of these three load levels, find the price that would have cleared the market if price were equal to cost, i.e. find the point in the supply curve intersects the load curve (vertical line) in the plot.
6. Suppose we want to know if the dispatch of power plants is efficient, i.e. if cheaper plants are dispatched first. Do cheaper power plants produce more? To check this, do the following:
(a) Run an OLS regression of net generation on cost. What cost is the most relevant here? Try total cost and variable cost and argue why/how results vary with the cost definition. Briefly discuss.
(b) Now control for capacity, how do results change?
(c) What else could you be missing that may lead to bias? Can you control for it? Add some control that you consider relevant and discuss how it changes the results.
















