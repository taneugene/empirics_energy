```{r message = FALSE}
# Notes for formatting:
# include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks.
# echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures.
# message = FALSE prevents messages that are generated by code from appearing in the finished file.
# warning = FALSEprevents warnings that are generated by code from appearing in the finished.
library(data.table)
library(readr)
library(readxl)
library(tidyverse)
```

---
title: "Empirical Exercise 2 Answer Key"
author: Eugene Tan
output: html_notebook
---

This problem set is due on October 26. I strongly recommend to start working on the homework early. You can work in pairs and submit a common solution. Please submit the homework as an R markdown file (if there are data files, they put all the files in a zip file). The code must run without errors. To make this easier, set the working directory at the beginning so it can be easily changed by someone else running the code.

For this exercise you will use a dataset collected by S&P Global. Choose one of the datasets available, which have data for either 2009 or 2018 for one of the following ISOs: MISO, PJM, ERCOT, or New England ISO. The goal of the exercise is to build the supply curve for a wholesale electricity market and to analyze how costs determine the composition of fuels and emissions. We will also use the exercise to see how things would change with a carbon tax.

#### Select the following variables from your dataset: 
* Plant Unit key
* Primary fuel type
* Generation technology
* Summer capacity MW
* Variable O&M cost per MWh (this is the variable cost)
* Total fuel cost per MWh (this is part of the variable cost) 
* Emission allowances costs (this is part of the variable cost) 
* Fixed O&M cost
* Heat rate btu/ kwh
* Heat input (MMBTU)
* Net generation MWh
* Capacity factor
* NOX Emissions Rate (lbs/MMBtu)
* SO2 Emissions Rate (lbs/MMBtu)
* CO2 Emissions Rate (lbs/MMBtu)

```{r echo = TRUE, warning = FALSE}
ercot2018 <- fread("data/ercot2018.csv")
ercot2009 <- fread("data/ERCOT_2009.csv")
ne2009 <- read_excel("data/ISO_NE_2009.xls", 
         col_types = c("text", "numeric", "numeric", 
         "text", "text", "text", "text", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "text", "text", "text", 
         "text", "text", "text", "text", "text", 
         "text", "text"))
ne2009 <- as.data.table(ne2009)
miso2018 <- fread("data/MISO2018.csv")
ne2018 <- fread("data/NEISO_2018.csv")
ny2018 <- fread("data/NYISO_2018.csv") 
pjm2009 <- fread("data/PJM2009.csv", skip = 31)

# Get all the data in one list and name it
alldata <- list(ercot2018, ercot2009,ne2009,miso2018,ne2018,ny2018, pjm2009)
names(alldata) <- c("ercot2018", "ercot2009","ne2009","miso2018","ne2018","ny2018", "pjm2009")

# Get a unique list of all the column names
oldcols <- unique(unlist(sapply(alldata, names)))

# Map each of these to the variable name I want
newcols <- c('name','pkey','pukey','unitno','fueltype','tech','operating','capacity','capacity_adj','capacity_cum','vcost_om', 'vcost_fuel','vcost_om2','vcost_om3','vcost_emissions','fcost','tcost_om','heat_rate','heat_input','net_generation','cap_factor','nox','sox','co2','cogen','gscfuelsrc','gscnonfuelsrc','gscallowsrc','gscheatratesrc', 'gscheatinputsrc','gscgensrc','nox_emratesrc','so2_emratesrc','co2_emratesrc','name')

# Print to see that these match up.
names(newcols) <- oldcols

# Now loop through all the dts and set the new names and only choose the columns we want. 
format <- function (dt){
  # Set the new names for each column
  setnames(dt,oldcols, newcols, skip_absent = T)
  return(dt)
}

# Apply the above fucntion
alldata <- lapply(alldata, format)
```

### Part 1
Start by cleaning and understanding your data. For this, do the following:
#### What does each variable represent?
Just check understanding here: 

* Plant Unit key is the plant unit key.  In each plant, there may be multiple generators with different marginal costs. So each generator or unit has its own unique row in the dataset
* Primary fuel type - form of primary energy, one of "Solar", "Other Fuel", "Water", "Coal","Uranium","Natural Gas","Biomass","Petroleum Products","".
* Generation Technology - form of generator, e.g. Combustion Turbine, Combined Cycle, Hydro, Nuclear, Pumped Storage, Internal Combustion, Steam Turbine, Other, Solar, Wind.
* Summer capacity MW - capacity measured during summer
* Variable O&M cost per MWh - 

#### Assign convenient yet meaningful names to each variable in the dataset.
```{r}
# Get the list of columns we want to select
wantcols <- c("pukey",'fueltype',"tech","capacity","vcost_om","vcost_fuel","vcost_emissions","fcost","heat_rate","heat_input","net_generation","cap_factor","nox","sox","co2")

selec <- function (dt){
  # Select only the columns we want
  dt <- dt[,..wantcols]
  return(dt)
}

alldata <- lapply(alldata, selec)

# Print the top couple rows of each to see that it worked. 
lapply(alldata, dim) # Check there are 15 columns
```

#### What is the class of each variable? Make sure to convert them to the proper class before doing this. For example, if net generation is a character, make it numeric.
```{r}
# ANSWER KEY ONLY: I'll join all the data to be one data type in order not use loops 
# all the time for readability, and filter at the end to make it work for each graph. 
dt <- rbindlist(alldata, use.names = TRUE, idcol = 'isoyear')
# Capture the iso (as many characters as you like from a-z at the beginning)
dt[,iso:=str_match(isoyear,"^[a-z]*")] 
# Capture the year (4 digits from 0-9)
dt[,year:=as.integer(str_match(isoyear,"[0-9]{4}$"))] 


# Select the ones that I want to change the type of using a regular expression
convert_cols <- names(dt)[grepl('cost|heat|gen|cap',names(dt))]

# Some data cleaning needed before changing to numeric. 
# gsub isn't vectorized, so can't do this in data.table. 
for (col in convert_cols){
  # This is needed for all except ne2009
  # There are some commas that separate numbers that result in nas e.g. 100,000
  dt[[col]] <- gsub(",","",dt[[col]]) 
  # For pjm 2009 only because 0s are entered as "(0.00)"
  dt[[col]] <- gsub("\\(","",dt[[col]])
  dt[[col]] <- gsub("\\)","",dt[[col]])
}

# error checking why 
#error <- dt[,as.numeric(vcost_emissions)]
#dt[is.na(error)]


# Convert the columns to the right datatype. 
dt[, (convert_cols) := lapply(.SD, as.numeric),.SDcols = convert_cols]
# Check it worked
str(dt)
```

#### Describe each variable: what values does it take? Do you have any concerns about some variable (extreme values, missing values)?
```{r}
str(dt)
summary(dt)

# Extreme values:

# Heat rate - the generator shouldn't be able to produce more secondary than primary energy. 
dt[,energy_efficiency := 3412.14/heat_rate] # convert btu/kwh to kwh/kwh
# Problematic generators by dataset
dt[energy_efficiency>1, .N, by =isoyear] 

# Capacity factor should be <100
dt[cap_factor>100]
dt[cap_factor>100, .N, by =isoyear] 
# Total problematic rows
dt[energy_efficiency>1|cap_factor>100] 
dt[energy_efficiency>1|cap_factor>100, .N, by =isoyear] 

# Missing values - can't say anything here really.
# Anything with fuel type missing is just an empty row that was imported by accident.
dt<-dt[!fueltype == ""]
summary(dt)
dt[is.na(net_generation), .N, by = isoyear]
dt[is.na(net_generation), .N, by = fueltype]
dt[is.na(net_generation), .N, by = tech]
```

### Part 2
Now let’s look at the importance of each fuel in this market.
#### a
What is the fuel composition of this market according to capacity (i.e. how
much capacity for each fuel)? Show it in a pie chart.
```{r}

for (name in names(alldata)){
# Nest ggplots in print if your ggplots are on loop
  print(
    ggplot(dt[isoyear == name,.(capacity = sum(capacity, na.rm=T)), by = fueltype], aes(x = "",y = capacity, fill = fueltype)) + 
    geom_bar(stat="identity", width=1) +
    coord_polar("y", start=0)+
    ggtitle(name) + 
    theme_void()
    # Want to find out how to add labels for capacity here.
  )
}

```
#### Part b
(b) What is the fuel composition of this market in terms of net generation?
Show it in a pie chart.

```{r}

for (name in names(alldata)){
# Nest ggplots in print if your ggplots are on loop
  print(
    ggplot(dt[isoyear == name,.(net_generation = sum(net_generation, na.rm=T)), by = fueltype], aes(x = "",y = net_generation, fill = fueltype)) + 
    geom_bar(stat="identity", width=1) +
    coord_polar("y", start=0)+
    ggtitle(name) + 
    #ggsubtitle('Net Generation by Capacity by share of total')+
    theme_void()
    # Want to find out how to add labels for capacity here.
  )
}

```


(c) Why are they different or similar?
This depends on the iso that students do, but the question of what is baseload and what are peaker plants and excess load plants will generally be accepted.

(d) How much does each fuel contribute to NOx, SO2, and CO2 emissions? Choose an appropriate plot type to answer this.

There are various ways to answer this:

1. Take the emissions rate, multiply by net generation, and that's the actual total emissions for that ISO.  
1. You could also just do a bar plot for each average emissions rate.
  But this doesn't make sense or SO2 or NOx since they vary by plant. 
- I would edit part 2b to clarify that we want the first. - calculate toal emissions in your ISO.

```{r}
# Set the groupby key
setkey(dt, isoyear, fueltype) # Students should take out isoyear

# Emissions by dataset - fueltype
ggplot(dt[,.(emissions = sum(heat_input*co2, na.rm=T)), by = key(dt)],aes(x = factor(isoyear), y= emissions, fill = factor(fueltype))) + 
  geom_bar(stat = 'identity', position = 'dodge') + 
  scale_y_continuous(name = "Emissions (lbs)") + 
  scale_x_discrete(name = "ISO and year") + 
  scale_fill_discrete(name = "Fuel Type")
  

for (name in names(alldata)){
  print(
    ggplot(dt[isoyear == name,.(emissions = sum(net_generation*co2, na.rm=T)), by = key(dt)],aes(x = factor(isoyear), y= emissions, fill = factor(fueltype))) + 
  geom_bar(stat = 'identity', position = 'dodge') +
  scale_y_continuous(name = "Emissions (lbs)") + 
  scale_x_discrete(name = "Fuel type") + 
  scale_fill_discrete(name = "Fuel Type") + 
  ggtitle(paste(name,"- Emissions by fuel type"))
  )
}
# Unnecessary data cleaning for the answer key. 
if (F){
  # Assume that if there is na generation, that no electricity was produced
  dt[is.na(net_generation), net_generation:= 0] 
  
  # Checks which fuels have no emissions factors
  dt[, mean(co2, na.rm=T), by = key(dt)]
  dt[, mean(sox, na.rm=T), by = key(dt)]
  dt[, mean(nox, na.rm=T), by = key(dt)]
  
  # Assume that renewable fuels are zero-emissions if they do not already have a value assigned.
  renewables <- c('Solar','Uranium','Water','Wind')
  dt[is.na(co2) & fueltype %in% renewables, co2 := 0.]
  dt[is.na(nox) & fueltype %in% renewables, nox := 0.]
  dt[is.na(sox) & fueltype %in% renewables, sox := 0.]
  
  # This is a reasonable but potentially bad assumption if the distribution of emisssions factors is skewed/fat-tailed, but I will set the nas for other emissions factors to be the mean or max of the distribution
  dt[is.na(nox), nox := mean(nox, na.rm = T), by = c('fueltype','tech')]
  
  summary(dt)
}
```

3. Organize the data and plot the generation supply curve using a different color for each fuel (Check here for a reference about supply curves.). The idea is to have a plot in which each plant is a dot, its height is its variable cost and its x- coordinate is the capacity of the system at a cost equal or lower than the plant’s. For this, you have to order generators according to variable cost, and calculate the cumulative capacity of the system. Use geom point such that each plant is a dot, but do not connect the dots. Label the plot properly, add a title and a legend.

```{r}
# The vcost_fuel is a component o fthe the operating cost, we see here that it never goes above the x = y line. 
ggplot(dt, aes(x = vcost_om, y = vcost_fuel)) + 
  geom_point()

# Order generators according to variable cost
setorder(dt, isoyear, vcost_om)

# calculate the cumulative capacity of the system
dt[, cum_capacity := cumsum(capacity), by = isoyear]

# Draw the supply curve for all ISOs.
ggplot(dt, aes(x = cum_capacity, y = vcost_om, color = isoyear)) + 
  geom_point() + 
  xlab("Cumulative Summer Capacity (MW)")+ 
  ylab("Variable Cost ($/MWh)")

scs <- list()
# Draw the supply curve by iso using a different color for each uel. 
for (name in names(alldata)){
  scs[[name]] <-ggplot(dt[isoyear == name], aes(x = cum_capacity, y = vcost_om, color = fueltype)) + 
    geom_point() + 
    xlab("Cumulative Summer Capacity (MW)")+ 
    ylab("Variable Cost ($/MWh)")+
    ggtitle(paste(name, "Supply Curve"))
}
scs
```

4. In the supply curve, are fuels ordered by cost? What do you think is the role of cost in explaining the differences between the capacity and net generation shares of each fuel?

Fuels are ordered by variable cost, not total cost. The higher the variable cost is, the lower the capacity factor should be (this is net generation over total theoretical generation, which scales with capacity).

5. Now you will create three values that we will use to represent load. Let’s assume average load is 60% of capacity, winter peak is 80% of capacity, and summer peak is 90% of capacity.
(a) Compute these three values of load.

```{r}
load <- dt[, .(total_capacity = max(cum_capacity)), by = isoyear]
load[,`:=`(avg_load = .6*total_capacity, winter_peak = .8*total_capacity,summer_peak = .9*total_capacity)]
load
```
(b) Add the load values to the supply curve plot as vertical lines. Save this plot
as a pdf file using ggsave. For each of these three load levels, find the price that would have cleared the market if price were equal to cost, i.e. find the point in the supply curve intersects the load curve (vertical line) in the plot.

```{r}
# Draw the supply curve by iso using a different color for each fuel. 
for (name in names(scs)){
  scs[[name]] <- scs[[name]] + 
    geom_vline(xintercept = load[isoyear ==name, avg_load])+
    geom_vline(xintercept = load[isoyear ==name, winter_peak])+
    geom_vline(xintercept = load[isoyear ==name, summer_peak])
  ggsave(paste("supplycurve", name, ".pdf", sep = ""), device = "pdf", width = 16, height = 9, units = "in")
}
scs
```


6. Suppose we want to know if the dispatch of power plants is efficient, i.e. if cheaper plants are dispatched first. Do cheaper power plants produce more? To check this, do the following:
(a) Run an OLS regression of net generation on cost. What cost is the most relevant here? Try total cost and variable cost and argue why/how results vary with the cost definition. Briefly discuss.

```{r}
dt[, tcost_om := vcost_om * net_generation]
dt[, tcost_fuel := vcost_fuel * net_generation]
dt[, tcost_emissions := vcost_emissions * net_generation]
ds <- dt[isoyear == "ercot2009"]

# Naive regression, noting that vcost_fuel is collinear with vcost_om
model1 <- lm("net_generation ~ vcost_om +vcost_fuel + vcost_emissions + fcost", ds)
summary(model1)

# Same using total variable costs as in the question rather than 
model2 <- lm("net_generation ~ tcost_om +tcost_fuel +tcost_emissions + fcost", ds)
summary(model2)

model3 <- lm("net_generation ~ tcost_fuel +tcost_emissions + fcost", ds)
summary(model3)
```

(b) Now control for capacity, how do results change?
```{r}
# Naive regression, noting that vcost_fuel is collinear with vcost_om
model4 <- lm("net_generation ~ vcost_om +vcost_fuel + vcost_emissions + fcost + capacity", ds)
summary(model4)

# Same using total variable costs as in the question rather than 
model5 <- lm("net_generation ~ tcost_om +tcost_fuel +tcost_emissions + fcost +capacity", ds)
summary(model5)

model6 <- lm("net_generation ~ tcost_fuel +tcost_emissions + fcost +capacity", ds)
summary(model6)
```

(c) What else could you be missing that may lead to bias? Can you control for it? Add some control that you consider relevant and discuss how it changes the results.

We are looking at the effect of cost on generation, one thing we could be missing is the generator type and how long the generator takes to start and shut down. We can proxy for that by adding a dummy for generator type.

```{r}

```





7. (Extra credit) Now you will calculate the profits that each generator would have made if the price had been the price you find assuming average load (the price on an average hour).
(a) First, calculate profits, which are given by (P − mc)Q. Use variable cost as marginal cost, quantity is net generation. Describe profits by fuel type. For this, create a table that includes minimum, percentile 25, mean, median, percentile 75, and max value for each fuel type (fuel types are rows).




(b) Now compute total profits considering fixed costs (P −mc)Q−F, and create the same table as above. Do firms cover their costs?
8. (Extra credit) Now we will repeat the same exercise but with social cost instead of private cost.
(a) We will use $50 for the social cost of carbon, but write your code using it as a parameter such that you can easily change it (Define scc as a variable at the beginning, and use scc instead of the actual value in the code. ).
(b) Compute the social variable cost for each generation. First, combine heat rate, heat input, and CO2 emissions rate to obtain CO2 tons emitted per MWh. In the data we have the emission rates in lbs/MMBTU for CO2. We also have the heat input in MMBTU. Therefore, by multiplying both variables we can construct the emission in lbs. Then, multiplying this variable by a constant k = 0.00045359237 we can convert from lbs to tons. Finally, we know the generation in MWh. So, we can calculate the emissions in tons per MWh.
CO2 Emissions ratei (tons/MWH) =
Emission ratei (lbs/MMBTU) · Heat inputi (MMBTU) · k (ton/lbs)
Generationi (M W h)

(c) Plot the social cost supply curve and load. Find the price that would clear if load was equal to average load (call this P S ), and the corresponding quantity.
9. (Extra credit) Now we will compare total emissions in a world that dispatches plants according to private variable cost (as it is today), with a world in which plants are dispatched according to social cost (which would happen with a tax on carbon, for example).
(a) Calculate total emissions during an average hour assuming firms are dispatched according to social cost. For this, you have to follow these steps:
i. Create variable that indicates whether a plant operates or not in an average hour (it operates if its social cost is lower than or equal to PS).
ii. Create another variable with each plant’s emissions assuming they
produce at capacity (why capacity? Think of the supply curve).
iii. Then add up emissions for all plants that operate when the price is lower
than or equal to PS.
(b) Find total emissions for the case in which plants are dispatched according to private variable cost, not social cost, using the procedure above. Notice that now a plant operates if its variable cost is at or below the clearing price calculated in 5c.
(c) How many tons could we save in an hour if the social cost of carbon were internalized? And in a day? And in a year? Comment about how the fuel shares of this particular market affect the results of this exercise.
(d) (Bonus) How does the above answer change with different values for the social cost of carbon?
(e) (Extra bonus) Can you write a function that helps you to compute this?






